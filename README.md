# greenhouse-APP
The system mainly consists of two parts: mobile terminal and server. The mobile terminal uses Android Studio as the development tool, uses Material Design to design UI interface, sends request data through OkHttp, and sqllite stores cached data. The server side uses MyEclipse as the development platform, adopts MVC mode design, uses servlet to process requests and uses MySQL database to store data. Mobile terminal design includes: 1. Real-time data: display greenhouse information, display real-time data of specific collection points in greenhouse; 2. Historical data: query the historical data of collection points, display them in the form of lists and polygons; 3. Equipment control: control of all equipment in greenhouse; 4. Equipment management: delete, modify and increase equipment; 5. Early warning settings: display greenhouse. Setting environmental parameters; 6. Early warning information: displaying abnormal environmental information in the greenhouse; 7. Weather query: inquiring weather information in the area where the greenhouse is located; 8. User center: displaying user information and modifying password. Server design includes: 1. Providing data: providing data interface for real-time data, historical data, user information, field and equipment list; 2. Data updating: updating user's new password, setting of environmental parameters of acquisition points, equipment information and early warning information.
## 系统主要包括由移动端和服务器两个部分构成。
   移动端用AndroidStudio为开发工具，使用Material Design设计UI界面，通过OkHttp发送请求数据，sqllite存储缓存数据。服务器端用myeclipse为开发平台，采用MVC模式设计，使用servlet处理请求，通过HTTP协议为移动端提供json格式的数据接口，使用mysql数据库存储数据。移动端设计包括1.实时数据:显示大棚信息，对大棚特定采集点的实时数据进行展示；2.历史数据：对采集点的历史数据进行查询，以列表和折线图的方式显示；3.设备控制：对于大棚内的所有设备进行控制；4.设备管理：删除、修改、增加设备；5.预警设置：对大棚环境参数进行设置；6.预警信息：显示大棚内环境异常信息；7.天气查询：查询大棚所在地区的天气信息；8.用户中心：显示用户信息和修改密码。服务器端设计包括：1.提供数据：为实时数据、历史数据、用户信息、田地和设备列表提供数据接口；2.数据更新：更新用户新密码、采集点环境参数设置、设备信息和预警信息
   第一章 相关技术
1.1 Anndroid Studio
Android studio 简称AS，AS是谷歌在2013年5月推出一款开发软件，用于android开发，在2015年AS受到了广大开发者的喜爱，相比之前的版本，AS在2015年的发型版本界面更加流畅，编译挑错也更加全面，同时对于之前的android的开发工具eclipse，AS在运行速度，界面美观，安装难易度都要优于eclipse，本系统采用2019年发布的AS3.2版本。
1.2 MySQL
由于性价高，数据存储方便，数据的读写速度快，并发量高，并且免费使用，因此本次系统的服务器端就是采用MySQL数据库。
1.3 MVC模式
是服务器端设计的一种设计模式，使得代码更加有结构，逻辑更加清晰，代码更加容易读懂，同时也减轻了代码的工作量，使得代码的编写更加容易，服务器端的设计更加简单。
1.4 HTTP协议
在系统设计中，Android移动端向服务器使用get方式请求数据，服务器接受到客户端的请求之后，用servlet向客服端返回数据。客户端解析之后，显示到APP的ui界面上，实现移动端与服务器端的数据传输。
1.5 MPAndroidChart
用于系统折线图的绘制，不仅能够绘制折线图，还可以绘制其他类型的图表，柱形图，扇形图都可以，并且能够根据数据源自动进行调整折线图的大小，可行进行放大和缩小操作，上下滑动，左右滑动操作，使用方便简单。
1.6 SmartTable
该控件用于绘制系统的列表，控件的功能能够自动解析json格式数组，解析之后自动调整列表的行和列，且能够自适应地显示数据，并且当数据的列和行都比较多的时候，能够通过滑动查看更多的列和行。
第二章 系统需求分析
2.1系统可行性分析
在进行系统的设计之前，对系统的可行性进行分析，主要从三个方面进行分析，技术可行性，经济可行性，和操作可行性，来确保温室大棚信息采集分析系统设计的成功。
2.1.1技术可行性分析
使用androidstudio开发平台和androidSDK软件开发包，开发基于android的温室大棚监控APP。使用myeclipse开发软件，开发温室大棚监控系统web服务器程序，部署到Tomcat服务器上运行。服务器和移动端使用HTTP协议进行数据交互。服务器端用Mysql进行数据存储，移动端使用SQLite存储缓存数据和sharedpreference存储用户信息。在技术可行性上是可以实现的。
2.1.2经济可行性分析
系统的服务器程序需要部署到服务器上，对于农业大棚管理者来说，系统服务器是农业大棚中就包含的有的，因此无需额外的开销，系统的通讯协议是HTTP，因此需要将服务器端程序发布到网上，这个费用花销不大，大约每月30元左右的部署服务器费用，系统的APP需要安装到android手机上，目前，随着科技的发展，几乎人手一个android手机，况且，android手机价格低廉，并不需要很大的花销和成本，在经济可行性上是可以的。
2.1.3操作可行性分析
系统的服务器端为移动端提供数据接口，在操作上是封装好的。系统的移动端主要是App，界面简洁，操作简单，无需专业的技术人员，普通的用户都可以进行操作，在操作可行性上是没有问题的。
2.2系统功能需求分析
2.2.1系统用例图
温室大棚数据采集分析系统有两种用户角色，分别是大棚管理员，预警员。
每一种角色管理自己对应的大棚，一个大棚有一个管理员，一个管理员管理多个大棚，管理员只能管理自己的大棚。预警员能够对于温室大棚内的环境参数进行范围的设定，这需要专业的知识和水平，因此预警员负责设置对应的大棚环境参数。
 
图2-1 预警员用例图
 
图2-2 管理员用例图
2.2.2系统功能分析
通过对攸攸板镇温室农业大棚的调研，确定了系统要实现的功能，主要由设备控制，设备模块，预警模块，数据显示，历史数据，天气模块以及用户中心等7个主要模块组成。如图2-3
图2-3 系统移动端的功能图
1．个人信息：显示登录用户的用户名，联系电话，地址，邮箱和身份
2．修改密码：需要重新输入原密码进行校验用户身份。
3．显示查询区域（天气）：显示全国的省份，每个省份下所有的市，每个市，显示每个市下面的所有区域。
4．显示天气信息：对于选择的省份下面的特定的市下面的特定地区，进行天气查询，显示当天的天气的温度和天气情况，显示未来六天的最高温度和最低温度，以及天气情况，显示当天的天气质量，包括AQI指数和PM2.5，根据当天的天气状况给出生活建议。
5．折线图显示历史信息：可以对采集点的历史数据进行查询，以折线图的形式显示采集点的所有采集数据，查询条件包括开始时间和结束时间，时间格式为年月日，时分秒，数据源（原始数据，分钟数据，小时数据，天数据月数据），和参数（根据采集点的不同自动包含相应的采集参数，列如温度，光照等），折线图的横坐标时间，纵坐标是参数数据，可以对图进行缩放。
6．列表显示历史信息：能够对采集点的历史数据进行条件查询之后，列表显示采集点的历史数据，列表显示历史数据的查询条件包括，开始时间和结束时间的选择，格式为年月日，时分秒，和数据源（原始数据，分钟数据，小时数据，天数据，月数据），查询之后的结果用列表显示，列表的表头是某个采集点，列是数据参数，行是时间。
7．设备管理：对于温室大棚内的设备比如：卷帘，通风口，风机等设备进行编辑，修改设备的设备名，设备类型，设备状态，设备备注，另外能够对设备信息进行删除，对于设备中信息进行修改编辑。
8．采集点列表：每个温室大棚内会有多个采集点，先显示温室大棚，对于特定的温室大棚，显示温室大棚内的采集点列表，采集点列表里面会显示采集点的名字。点击之后才会显示采集点的具体采集参数
9．实时数据显示：点击采集点之后，显示采集点内的采集数据信息，显示采集点 的实时数据，数据会自动进行更新，每五秒钟进行更新一次，因为在硬件采集点设备中，五秒钟会将采集点的数据发送给服务器。不同的采集点的采集参数不同，相应的实时数据显示的时候也会自动进行改变和适应，并且采集数据的单位也会进行自动改变和适应。
10．预警信息：系统中对于采集点的实时数据不在相应的最大值和最小值之间的数据进行预警，显示该所在大棚的所在采集点的某个参数为异常警报，显示警报的发生时间，显示警报的类型，警报类型有两种，环境警报，设备警报；环境警报是上一种情况，设备警报是在单位时间内没有收到来自设备的最新数据，会发出警报，同时显示警报是否处理。
11．预警设置：对于温室大棚的个个环境参数进行最大值和最小值设定，规定温室大棚内的所有采集点不能超过设置的最大值和最小值，对于超过最大值和最小值的采集点进行预警。
12．设备控制：温室大棚内的设备的种类有两种，开关设备，只有两种状态，开和关；量程设备，设备的状态有三种，开，关和开关，处于开关状态中，会有一个量程的大小来表示开关的开合度，因此成为量程设备，比如天窗设备，就是一种量程设备，能对开关设备进行开关操作，可以对量程设备进行设备的张合度进行设置。
13．视频监控：实时显示温室大棚的实时环境状况，显示温室大棚的实时监控视频。
2.3系统性能需求分析
1．稳定性：确定移动终端系统不会因为数据异常而发生APP出错，导致系统出错，退出App，能够确保系统的稳定运行。不会出现闪退，或者登陆异常等状况，能够对于相应时间过长的进程，直接进行结束，并且确保系统的退出时刻有效。
2．流畅性：确保系统的相应时间在1s中之内，并且App界面与界面之间跳转流畅，运行流畅，占用资源少，占用系统内存小，软件反应速度迅速。
3．易操作行：简单易于操作，对于非专业人员能够轻易上手，很容易熟悉系统的功能，能够对系统的功能进行流畅操作。
4．安全性：能够保护用户的个人信息安全，软件需要将数据存放于服务器中心的同时还应将数据进行备份工作，用以再出现数据丢失时可以对数据进行必要的恢复。
5．美观性：APP界面简明明了，考虑用户体验，界面美观大方，并且能够流畅显示数据内容和控制设备。
6．扩展性：能够对于不同的温室大棚，不同的采集点数据，不同的大棚内的设备，不同的预警条件都能够自动进行适应，自动调节相应的显示和控制，后期系统可以进行模块嵌入，进行扩展功能。
7．兼容性：图2.2是截止于 2018 年 10 月 26 日，Google公司提供的android版本市场的占有率。可以发现：Android4.4以下的市场份额仅有4.1%，考虑到大部分手机的版本都在4.4以上，为了使手机App兼容手机的android版本，因此开发的时候为android4.4版本为主要开发对象。
 
图2-4 Android分支版本市场份额数据图
第三章 系统设计
系统总体上有三个部分构成：服务器，客户端和数据库，服务器端根据接受用户请求进行数据处理，为客户端端提供数据接口。客户端使用HTTP协议来传输用户请求，解析服务器返回json格式数据。服务器端的MySQL数据库存储硬件设备采集的数据，保存用户信息和设备状态。

 
图3-1 系统结构图
3.1 客户端端设计
客户端是基于android的移动端，客户端的设计主要包括，数据存储设计，UI界面设计，数据获取设计和功能设计四个部分。
3.1.1 数据存储设计
安卓端数据大部分来源于服务器,还有一部分是要缓存的数据，这部分数据使用SQLite进行存储，这些缓存的数据一部分是天气信息。使用网上免费的天气接口，由于要查询的天气信息是不同地方的，所以对全国所以的省，省下所有的市，以及市下所有的县进行存储，能够提高系统的运行数据。 另一部分的数据的存储是用户信息的存储，存储到sharedpreference（下面简称SP）里面，由于在不同的功能中需要对用户权限和身份的判定，因此将用户信息存储到SP中，能够实现在不同的activity中获取用户的权限和身份，然后进行判断，除了用户信息的存储之外，对于需要跨两个或者两个以上activity的信息量，也是用了SP进行数据的存储，在activity和适配器adapter之间使用SP进行数据的传递，在fragment和activity之间也可以使用了SP进行数据的传递。
3.1.2 UI界面设计
android主要功能框架由material design设计的，然后使用了adapter，listview，recycleview，以及一些基本的控件，在进行历史数据的表格显示和折线图显示时，使用了smarttable进行信息的显示，在本章的前面对于smarttable有详细的描写，折线图显示采用的MPandroid控件进行显示，在本章的前面对MPandroid也有详细的描写， 对于年月日，时分秒的显示中需要采用了自定义的控件，以及设备管理中，天气显示中，都需要写了一些自定义的控件。     
3.1.3 数据获取设计 
由于大部分的数据都是通过访问服务器获得的，因此，数据的获取主要是对服务器返回的json数据进行解析，以及发送请求信息，两部分构成，首先发送请求信息，主要通过在访问服务器的url后面跟上请求的参数，参数的值用等号赋予，参数的连接用&号进行连接将请求的数据发给服务器。接着是数据解析，数据的解析使用到了JSONObject以及天气信息数据的解析使用到了GSON。  
3.1.4 功能设计
通过对攸攸板镇温室大棚的实地考察，我们确定了系统的功能需求，在实地考察中，温室大棚的采集信息设备各种各样，实际生产中需要对各类温室大棚的设备都要考虑到，采集设备需要对光照，土壤温度，土壤湿度，空气温度，空气湿度，溶解氧，PH值，水温，NH4+，电导率，浊度，盐度，CO2浓度，氨气，硫化氢，风速，风向，雨量，水位等参数的测量，为了能够提高APP的通用性，采取将温室大棚之外的其他类型的大棚形式进行分析，形成一个通用性很强的农业大棚APP，对于信息的采集调查完毕之后，又通过对的设备进行了调研，主要包括以下设备，摄像机，硬盘录像机，水泵，电磁阀，卷帘，风机，补光灯，电热暖风机，卷膜机，湿帘，微雾加湿器，喷洒管，顶喷淋，天窗，外遮阳网，内遮阳网，棉帘，通风口，其中考虑到内蒙古自治区特有的地区气候和特点，棉帘和通风口是特有的设备。
基于安卓系统的农业温室大棚管理系统了历史数据，设备控制，设备管理，数据显示，用户中心，预警，天气查询七个主要模块。
用户中心模块：登录到系统如图3-2，对用户进行判断，目前有两种用户，一种是管理员，一个管理员可以管理多个农业大棚，管理员登录到APP系统当中，只会显示当前的管理人管理的农业大棚，相应的可以控制农业大棚的设备，另一种是预警员，负责农业大棚的环境参数设置。
图3-2 登录流程图
数据显示模块：显示地块列表，包括地块名称、地块面积、地块作物、地块类型和地块管理人。地块列表下，显示地块里面的采集点，采集点是一组信息采集设备的集合，信息采集设备可能会对土壤温度，土壤湿度，空气温度，空气湿度，溶解氧，PH值，水温，NH4+。数据显示流程如图3-3。
历史数据模块：查历史数据，显示历史数据的方法有两种，一种是列表显示查询结果，一种是图表显示历史数据。如图3-4。
图3-4 历史数据模块流程图
设备管理模块：对于温室大棚内的设备进行管理。如图3-5。
图3-5 设备管理模块流程图
设备控制模块：会显示田地列表，田地列表下面会显示田地里面所有的设备列表，在设备列表中会显示设备的名字，类型，设备的状态，设备的描述。分为两种，一种是开关设备的，只有两种状态，开和关，比如电磁阀设备，通风口设备，天窗设备。一种是量程可控制设备，比如棉帘等。如图3-6。
图3-6 设备控制模块流程图
预警模块主要有两部构成，预警设置和预警信息，预警设置：显示田地，之后显示土壤温度，土壤湿度，空气温度，空气湿度，溶解氧，PH值，水温，NH4+，电导率，浊度，盐度，CO2浓度，氨气，硫化氢，风速，风向，雨量，水位的最高值和最小值的原先设置值。对于大棚内的各种采集参数还可以进行最大值和最小值的更改。预警信息：对于当实时数据超过最大值和最小值得范围时发出的预警信息。
天气查询模块，能够查询不同地区的当前天气信息。如图3-7。




图3-7 天气查询模块流程图
3.2 服务器端设计
服务器端采用myeclipse+tomcat服务器部署，进行web服务器的开发，实现为安卓端提供数据接口，处理数据功能。根据androind端的请求数据，获得请求中的参数，然后对于数据进行处理，提供给客户端数接口。
这部分的详细设计主要使用到了MVC模式，model层面主要是对于从数据库中获取的数据进行存储，在系统的后期设计中，渐渐不使用model了，直接将从获取的数据库存到jsonObject对象中，controler用于数据的处理，数据的处理主要是使用servlet进行，在相应的get方法中对于数据进行处理，数据的处理和获取都要访问数据库，因此DAO层主要是对于访问数据的各种方法进行封装，以便controler层面进行调用。MVC模式用于服务器端的设计，能够使得服务器的设计更加容易简便，使得代码更加具有层次感，代码能够很快的进行模块化，能够使得程序的编写更加方便。
下图是服务器端要设计的接口图3-8。
图3-8 服务器接口图
3.3 数据库设计
本系统服务器端使用MySQL数据库，设计了两个数据库，分别是：arg-piot-newedition-dts和arg-piot-newedition-ifs，其中后缀为dts的数据库主要是对系统中采集点以及采集数据进行存储，而后缀为ifs主要是对用户信息，田地信息，设备信息，预警信息的存储。
3.3.1 实体关系图
arg-piot-newedition-dts数据库实体关系图。

 
图3-9 采集点实体属性图


 
图3-10 采集参数实体属性图



图3-11 采集点和采集参数实体关系图




arg-piot-newedition-ifs数据库实体关系图。
 
图3-12 员工实体属性图
 
图3-13 用户实体属性图
 
图3-14 角色实体属性图
 
图3-15 田地实体属性图
 
图3-16 种植物实体属性图

 
图3-17 温室大棚实体属性图
 
图3-18 设备实体属性图

图3-19 预警实体属性图
3.3.2 arg-piot-newedition-dts数据库表设计
该数据库主要由采集点信息表，采集点数据单位表，采集点原始信息表，采集点分钟数据信息表，小时数据信息表，天数据信息表和月数据信息表构成。采集点都有一个mn号，这个mn号用于唯一标识该采集点，同时也是用于采集点数据表的组成部分之一，采集点的采集参数集合，是采集参数编码组成，中间用分号隔开，用于说明采集点的采集项，每个采集点唯一所属包含一个田地id， 在本系统中，有多少个采集点，相应的就会有五张表用来存储采集点采集的原始数据，小时数据，分钟数据，天数据，以及月数据。

 
图3-20 温室大棚实体关系图
因此本系统以其中一个为例进行列表，以采集点的mn号是0013a20040b0eaee为例，那这五张表是：mt_0013a20040b0eaee原始数据表mt_0013a20040b0eaee_minutely分钟数据表，mt_0013a20040b0eaee_hourly小时数据表，mt_0013a20040b0eaee_daily天数据表以及mt_0013a20040b0eaee_monthly月数据表。在分钟数据表中，表内的数据项有一种数据参数，会有三种对应的参数形式，列如，参数编码为S1的参数名字是关照，S1_MIN表示的是在这一分钟内的关照的最小值，S1_MAX表示在这一分钟内光照的最大值，而S1_AVG表示在这一分钟内光照的平均值，每一个参数编码代表着不同的最大值和最小值以及平均值.mt_0013a20040b0eaee_hourly小时数据表里面的字段跟这张表类似，不同的是时间不在是一分钟内的参数的最大值，最小值，平均值，而是一个小时内数据参数的最大值，最小值，和平均值，mt_0013a20040b0eaee_daily天数据表，mt_0013a20040b0eaee_monthly月数据表也是这些字段，不过分别表示的是一天，一个月，内的最大值，最小值和平均值，这些表能对于采集点采集的数据进行详细的记录，方便了数据的查询。

 表3-1 数据库中表的描述
编号	表的名称	表的描述
1	dataitem	对于采集点的单位表
2	mt_node	采集点的信息表
3	mt_0013a20040b0eaee	采集点的原始数据信息表
4	mt_0013a20040b0eaee_daily	采集点的天数据信息统计表
5	mt_0013a20040b0eaee_hourly	采集点的小时数据信息统计表
6	mt_0013a20040b0eaee_minutely	采集点的分钟据信息统计表
7	mt_0013a20040b0eaee_monthly	采集点的月数据信息统计表
表3-2 采集参数信息表
字段名称	数据类型	字段长度	是否为空	说明
id	bigint	20	否	主键，采集参数id
code	varchar	255	否	采集参数编码
name	varchar	255	否	采集参数名字
value	varchar	255	是	采集参数值
itemType	int	255	是	采集参数类型
createTime	datetime	255	是	创建时间
unitKindKey	varchar	255	是	采集参数单位
unitKey	varchar	255	否	参数单位名字
group_	varchar	255	是	采集参数分组
表3-3 采集点信息表
字段名称	数据类型	字段长度	是否为空	说明
id	bigint	20	否	主键，采集点id
nodeTypeCode	varchar	255	否	采集点类型编码
name	varchar	255	否	采集点名字
mn	varchar	255	是	采集参mn号
measureFactors	varchar	255	是	采集参数集合
createTime	datetime	0	是	采集点创建时间
nodeId	bigint	255	否	田地id


表3-4 mt_0013a20040b0eaee原始数据表
字段名称	数据类型	字段长度	是否为空	说明
ID	int	11	否	主键，原始数据id
DATETIME	datetime	0	是	数据的采集时间
STATE	int	11	是	数据采集的状态
F_S1	double	0	是	数据项
F_S2	double	0	是	数据项
F_S6	double	0	是	数据项
F_S7	double	0	是	数据项
F_S5	double	0	是	数据项
表3-5 mt_0013a20040b0eaee_minutely分钟数据表
字段名称	数据类型	字段长度	是否为空	说明
ID	int	20	否	主键，原始数据id
MN	varchar	32	是	采集点的mn号
DATE_HOUR	varchar	16	是	数据的采集时间
S5_MAX	double	0	是	数据采集的状态
S6_MAX	double	0	是	数据项
S7_MAX	double	0	是	数据项
S2_MAX	double	0	是	数据项
S1_MAX	double	0	是	数据项
S5_MIN	double	0	是	数据项
S6_MIN	double	0	是	数据项
S7_MIN	double	0	是	数据项
S2_MIN	double	0	是	数据项
S1_MIN	double	0	是	数据项
S5_AVG	double	0	是	数据项
S6_AVG	double	0	是	数据项
S7_AVG	double	0	是	数据项
S2_AVG	double	0	是	数据项
S1_AVG	double	0	是	数据项
3.3.3 arg-piot-newedition-ifs数据库表设计
角色表中额角色名字目前有超级 管理员，能够拥有系统所有的权限，游客，作为登录到系统中的用户，测试，主要管理设备中设备，操作人员，拥有对田地和设备的控制权。设备类型表里面主要是放的设备种类，各种设备，列如，摄像头，硬盘录像机，棉帘，卷膜机等等，其中的设备编码是设备田地对应地图表中的设备类型字段，设备类型编码的小写对应的是设备表的名字。设备操作类型表定义了对设备的所有大的操作，比如开，关，开停，关停等，对于有量程的设备，同时可以定义开的尺度。由于设备表里面的字段大致相同，因此对于在数据库中所有的设备表以其中一个equip_wind_machine 风机设备表作为讲解进行说明，其余的设备表因为篇幅问题，不再列举。
表3-6 数据库中表的描述
编号	表的名称	表的描述
1	staff	职员表
2	users	用户表
3	users_roles	用户角色对应表
4	roles	角色表
5	agr_copany	公司表
6	agr_plant_2	种植田地表
7	agr_crop	农作物表
8	agr_field	田地表
9	agr_field_equipment_map	设备田地对应表
10	agr_equip_type	设备类型表
11	agr_equip_operate_type	设备操作类型表
12	agr_equip_operate_set	设备操作集合表
13	equip_electric_heater	电热暖风机设备表
14	equip_fill_light	补光灯设备表
15	equip_hopper_window	天窗设备表
16	equip_in_shade_net	内遮阳网设备表
17	equip_mianlian	棉帘设备表
18	equip_micromist_humidifier	微雾加湿器设备表
19	equip_out_shade_net	外遮阳网设备表
20	equip_rollfilm_machine	卷膜机设备表
21	channel	摄像头设备表
22	equip_roof_sprinkling	顶喷淋设备表
23	equip_shutter	卷帘设备表
24	equip_solenoid_valve	电磁阀设备表
25	equip_sprinkler_irrigation	喷洒灌设备表
26	equip_tongfengkou	通风口设备表
27	equip_water_pump	水泵设备表
28	equip_wet_curtain	湿帘设备表
29	equip_wind_machine	风机设备表
30	dvr	硬盘刻录机设备表
31	agr_access_server	服务器信息表
32	agr_plc	PLC信息表
33	agr_gateway	网关信息表
34	agr_eas_alarm	预警信息表
35	agr_eas_alarm_code	预警类型表
36	 agr_eas_type	预警方式表
表3-7 职员信息表
字段名称	数据类型	字段长度	是否为空	说明
ID	bigint	20	否	主键，职员的id
COMID	bigint	255	否	外键，公司id
NAME	varchar	255	否	职员姓名
USERID	bigint	255	是	职员的用户名
POSITIONID	bigint	255	是	职员的职位
TELEPHONE	varchar	255	是	电话号码
MOBILEPHONE	varchar	255	否	手机号码
EMAIL	varchar	255	是	电子邮箱
ADDRESS	varchar	255	是	家庭地址


表3-8 用户信息表
字段名称	数据类型	字段长度	是否为空	说明
ID	bigint	20	否	主键，用户的id
NAME	varchar	255	否	姓名
PASSWORD	varchar	255	是	密码
CREATETIME	datetime	255	是	创建时间
表3-9 用户角色表
字段名称	数据类型	字段长度	是否为空	说明
ROLEID	bigint	20	否	主键，用户的id
USERID	varchar	255	否	外键，用户id
表3-10 角色表
字段名称	数据类型	字段长度	是否为空	说明
ID	bigint	20	否	主键，角色id
COMID	bigint	20	是	外键，所属公司id
NAME	varchar	255	否	角色名字
表3-11 公司表
字段名称	数据类型	字段长度	是否为空	说明
ID	bigint	20	否	主键，角色id
CODE	bigint	20	否	公司编码
NAME	varchar	255	是	公司名字
PERSON	varchar	255	是	公司法人
ADDRESS	varchar	255	是	地址
REGION_ID	varchar	255	否	外键，管理区域
表3-12 种植田地表
字段名称	数据类型	字段长度	是否为空	说明
ID	bigint	20	否	主键，角色id
FIELDID	bigint	20	否	外键
CROPID	bigint	20	是	外键
USERID	bigint	20	是	外键users的id
STARTDATE	datetime	255	是	种植的开始时间
ENDDATE	datetime	255	否	种植结束时间
表3-13 农作物表
字段名称	数据类型	字段长度	是否为空	说明
ID	bigint	20	否	主键，农作物id
COMID	bigint	20	是	所属公司id
NAME	varchar	128	是	农作物名字
DESCRIPTION	varchar	512	是	农作物的描述
PIC	varchar	256	是	农作物图片
表3-14 农作物表
字段名称	数据类型	字段长度	是否为空	说明
ID	bigint	19	否	主键，田地id
NAME	varchar	512	是	田地名字
DESCRIPTION	varchar	128	是	田地描述
TYPE	varchar	512	是	田地类型
SA	varchar	256	是	田地占地面积
LAT	varchar	256	是	田地地理位置
表3-15 设备田地对应地图表
字段名称	数据类型	字段长度	是否为空	说明
ID	bigint	19	否	主键，id
COMID	bigint	512	是	所属公司id
FIELDID	bigint	128	否	外键
EQUIPMENT_TYPE	varchar	512	是	设备类型
EQUIPMENTID	bigint	256	是	设备id
表3-16 设备类型表
字段名称	数据类型	字段长度	是否为空	说明
ID	bigint	20	否	主键，id
NAME	varchar	128	否	设备名字
CODE	varchar	32	否	设备编码
NODE_TYPE_CODE	varchar	64	否	设备类型编码
OPERATE_SET	bigint	20	否	外键
STATUS	tinyint	4	否	设备状态

表3-17 设备类型操作表
字段名称	数据类型	字段长度	是否为空	说明
ID	bigint	20	否	主键，id
COMID	bigint	20	否	所属公司id
NAME	varchar	256	否	操作类型集合名字
STATUS	tinyint	4	否	状态
表3-18 风机设备表
字段名称	数据类型	字段长度	是否为空	说明
ID	bigint	20	否	主键，id
COMID	bigint	20	是	所属公司id
NAME	varchar	256	是	操作类型集合名字
DESCRIPTION	varchar	256	是	描述
STATE	varchar	256	是	设备情况
STATUS	int	11	是	设备状态
OPERATE_TYPE	int	11	是	设备操作类型状态
COMMAND_TYPE	int	11	是	设备命令类型
表3-19 服务器设备表
字段名称	数据类型	字段长度	是否为空	说明
ID	bigint	20	否	主键，id
NAME	varchar	128	是	服务器地址
COMID	bigint	20	是	公司id
IP	varchar	16	是	Ip地址
PORT	int	11	是	端口
表3-20  agr_plc表
字段名称	数据类型	字段长度	是否为空	说明
ID	bigint	20	否	主键，id
GATEWAY_ID	bigint	128	否	网关地址
NAME	varchar	128	否	plc名字
CODE	char	2	否	编码


表3-21 agr_eas_alarm预警信息表
字段名称	数据类型	字段长度	是否为空	说明
ID	bigint	20	是	主键，id
COMID	bigint	20	否	公司id
UPDATETIME	datetime	0	否	预警类型编码
CODEID	char	20	否	外键
TYPEID	bigint	20	否	外键
CONTEXT	varchar	512	否	预警内容
ISAUTOFIX	int	11	否	是否自动修复
ISFIXED	int	11	否	是否修复
STARTTIME	datetime	0	否	开始时间
FIXEDTIME	datetime	0	否	修理时间
表3-22 agr_eas_alarm_code预警类型编码表
字段名称	数据类型	字段长度	是否为空	说明
ID	bigint	20	是	主键，id
TYPEID	bigint	20	否	外键
NAME	varchar	512	否	预警名字
TEMPLATE	varchar	512	否	预警内容
表3-23 agr_eas_type预警方式表
字段名称	数据类型	字段长度	是否为空	说明
ID	bigint	20	是	主键，id
NAME	varchar	256	否	预警方式姓名
DESCRIPTION	varchar	256	否	预警方式描述
TIMEINTERVAL	bigint	11	否	预警间隔
3.4 本章小结
总本章对于系统的结构和功能进行了分析，从服务器和客户端两个方面上进行分析，服务器端主要是用于数据的存储，处理，以及为客户端传送数据，给客户端提供接口。对于android客户端进行功能分析和结构分析，android端主要是UI设计和数据的展示，sqlite和sharedpreference涉及到临时数据的存储，以及一些自定义控件的显示，然后就是对系统的功能进行分析，总体进行设计，下面进行对系统的详细设计。
第四章 系统实现
4.1 安卓端实现
1.登录界面
 
图4-1 登录界面图
2.系统主界面
 
图4-2 系统主界面图
3.用户中心模块：点击图4-2左上角的WSDP图标，显示个人信息，包括用户的用户名，用户头像，用户电话，用户邮箱，用户住址，用户的身份。如图4-3。点击用户头像下的EDIT PASSWORD 可以修改用户密码，修改用户密码时，需要输入原始密码和新密码以及确认密码。如图4-4
 
图4-3 个人信息界面图
 
图4-4 修改密码界面图
4.数据展示模块：点击返回按键，返回到系统主界面，然后点击数据展示。会显示当前用户root管理的大棚列表，如图4-5。点击3号地块图标，显示采集点列表，如图4-6。
 
图4-5 大棚列表界面图
 
图4-6 采集点列表界面图
点击大棚采集点后，显示采集点的采集数据，如图4-7。
 
图4-7 实时数据界面图
5.	历史数据模块：点击图4-7右上角的省略按钮，进行历史数据的查询。查询的结果又两种表现方法，折线图和列表。两种表现数据的查询方式不同，显示数据也不同。如图4-8和4-9，在折线图和类表中均可以进行左右滑动和上下滑动，查看全部数据，并且在折线图中能够对折线图进行放大和缩小操作，点击对应点能够显示点的纵坐标数据，十分灵活。
图4-8 折线图显示历史数据图
 
图4-9 列表显示历史数据图
6.	设备模块：设备模块有两部分：设备控制和设备管理，点击设备管理，会显示图4-5大棚列表，然后点击大棚，会显示所有的设备。如图4-10
图4-10 设备列表界面图
点击对应的设备可以进行设备控制，设备种类分为两种，一种开关设备，一种量程设备可以对两种设备进行控制。
7.	天气查询模块：天气查询模块可以对全国各地区的天气信息进行查询，系统选择内蒙古自治区呼和浩特市土左旗地区的天气信息进行展示，如图4-11。
图4-11 天气信息展示界面图
8.	预警模块：预警模块由预警设置和预警信息两部分组成，预警设置对于温室大棚的环境进行设置环境变化范围，设置环境参数的最大值和最小值，在设置之前，会显示以往设置的环境参数范围，如图4-12。
图4-12 预警设置界面图
预警信息是对于温室大棚内发生的环境异常和设备异常的信息进行显示，如图4-13.
 
图4-13 预警信息界面图
9.	监控模块：监控模块是通过手机客户端，实时观看温室农业大棚的情况，能对农作物进行观察和监控，如图4-14
图4-14 视频监控界面图
4.2 服务器端实现
服务器端为客户端提供数据接口和处理请求数据，该系统是通过servelet处理请求数据，通过json文件的格式发送给客服端。



接口名称	描述
Login	用户登录
Staff	用户查看个人信息
ModifyPw	修改用户密码
Greenhouse	查看温室大棚
Collecter	显示温室大棚内的采集点
Para	获取采集点的采集参数
ParaToUnit	获取采集参数的单位
Currentdata	获取采集点的实时数据
Historicaldata_chart	折线图显示采集点的历史数据
Historicaldata_list	列表显示采集点的历史数据
Devicelist	设备列表
WarnSet	预警设置
WarnInfo	显示预警信息
SetDeviceState	远程控制设备
editDevice	编辑和删除设备
editDevice	增加设备
获取采集点的实时数据接口
表4-2 Currentdata接口描述表
接口	Currentdata
描述	获取采集点实时数据
方法	GET
表4-3 Currentdata接口Request表
参数名	类型	是否必须	描述
mn	String	Y	采集点的mn号，用于采集点的唯一标识
sql	String	Y	采集参数，参数之间用，号相连的字符串
Colum	Int	Y	采集点的采集参数的个数



表4-4 Currentdata接口Response表
参数名	类型	是否必须	描述
Colum1	Double	Y	采集参数1的实时数据
Colum2	Double	Y	采集参数2的实时数据
Colum3	Double	Y	采集参数3的实时数据
ColumN	Double	Y	采集参数n的实时数据
Example
Request
{
"mn": "mt_0013a20040b0eaee",
    "sql": "F_S1,F_S2,F_S5,F_S6,F_S7",
    "colum": "5",
}
Response
{
"Colum1": "0.150000005960464",
"Colum2": "4.42000007629395",
"Colum3": "25.6299991607666",
"Colum4": "24.1000003814697",
"Colum5": "100"
}
折线图显示采集点的历史数据接口
表4-5 Historicaldata_chart接口描述表
接口	Historicaldata_chart
描述	折线图显示采集点的历史数据
方法	GET




表4-6 Historicaldata_chart接口Request表
参数名	类型	是否必须	描述
mn	String	Y	采集点的mn号
para	String	Y	采集参数
data	String	Y	数据源
Starttime	datatime	Y	查询的开始时间
Endtime	datatime	Y	查询的结束时间
表4-7 Historicaldata_chart接口Responset表
参数名	类型	是否必须	描述
time	String	Y	采集参数的采集时间
data	String	Y	采集参数的值
Example
Request
{
    "mn": "mt_0013a20040b0eaee",
    "para": "光照",
"data": "原始数据", 
"starttime": "2015-05-01 00:00:41"
"endtime": "2015-05-01 00:00:53"
}
Response
{
"time": "2015-05-01 00:00:47",
"data": "0.15259000658989"
}
 由于篇幅所限，服务器端接口实现仅仅以上面接口进行详细展示，对于其他接口的设计不再进行详细展示说明。



第五章 系统测试
系统使用白盒和黑盒对系统进行测试，对系统的7个模块进行单元模块测试，下面以用户模块，历史数据查询，实时数据显示，以及天气查询等主要模块进行测试。
5.1 功能测试
用户模块三个功能，个人信息展示，登录和修改密码三个功能，下面对于这三个功能进行详细分析测试。
表5-1 用户中心模块用例表
序号	输入操作	预期	结果	说明
1	输入用正确的户名和密码	登录到系统主页面	与期望一致	通过
2	用户名或者密码错误	停留在登录界面，提示用户名或密码错误	与期望一致	通过
3	用户名或者密码不输入	提示输入用户名和密码，停留在登录界面	与期望一致	通过
4	用户密码多次输入	提示输入密码次数过多，请稍后登录	与期望一致	通过
5	查看个人信息	显示个人详细正确的信息	与期望一致	通过
6	修改密码输入原密码错误	提示原密码错误，请从新输入	与期望一致	通过
7	新密码和确认密码不一致	提示新密码和确认密码不同	与期望一致	通过
8	新密码和原密码相同	提示重新输入新密码，新密码和原密码相同	与期望一致	通过







表5-2 历史数据模块用例表
序号	输入操作	预期	结果	说明
1	输入历史数据列表查询条件	列表显示查询的采集点数据	与期望一致	通过
2	输入跨度时间长的列表查询条件	能够列表显示大量的数据。	与期望一致	通过
3	输入开始时间早于结束时间的查询条件	提示输入正确的查询条件	与期望一致	通过
4	输入历史数据折线图方式查询条件	折线图方式显示查询的历史数据	与期望一致	通过
5	输入折线图查询跨度时间长的查询条件	以折线图的方式正确显示大量数据。	与期望一致	通过
6	修改密码时输入原密码错误	提示原密码错误，请从新输入	与期望一致	通过
表5-3 实时数据模块用例表
序号	输入操作	预期	结果	说明
1	点击常规五项采集点	显示采集点的常规五项参数。	与期望一致	通过
2	点击水产三项采集点	显示水产采集点的三项数据参数。	与期望一致	通过
3	点击气象11项采集点	显示气象采集的11项数据参数	与期望一致	通过
4	点击温湿度采集点	显示温湿度采集点的温度和湿度采集数据	与期望一致	通过
表5-4 天气查询模块用例表
序号	输入操作	预期	结果	说明
1	查询内蒙古自治区呼和浩特市土默特左旗地区	显示土默特左旗详细天气	与期望一致	通过
2	查询北京市海淀区	显示海淀区详细天气信息	与期望一致	通过
3	点击海南三亚市文昌地区	显示文昌地区详细天气	与期望一致	通过

























